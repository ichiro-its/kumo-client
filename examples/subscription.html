<!DOCTYPE html>
<html>
  <head>
    <title>Subscription Example</title>
  </head>
  <body>
    <div>
      <label for="websocketUrl">WebSocket URL</label>
      <input type="text" id="websocketUrl" value="ws://localhost:8080">
      <label for="nodeName">Node Name</label>
      <input type="text" id="nodeName" value="subscription">
      <input type="button" id="connectButton" value="Connect" onclick="connect()">
    </div>
    <div>
      <label for="topicName">Topic Name</label>
      <input type="text" id="topicName" value="topic" disabled>
      <label for="messageType">Message Type</label>
      <input type="text" id="messageType" value="std_msgs/msg/String" disabled>
      <input type="button" id="subscribeButton" value="Subscribe" onclick="subscribe()" disabled>
    </div>
    <ul id="output">
    </ul>
    <script>
      const websocketUrlInput = document.getElementById("websocketUrl");
      const nodeNameInput = document.getElementById("nodeName");
      const connectButton = document.getElementById("connectButton")
      const topicNameInput = document.getElementById("topicName");
      const messageTypeInput = document.getElementById("messageType");
      const subscribeButton = document.getElementById("subscribeButton");
      const outputList = document.getElementById("output");

      var socket = null;
      var nodeId = null;
      var subscriptionId = null;
      var id = 0;

      function send(message) {
        message.id = id;
        id += 1;

        if (socket) {
          socket.send(JSON.stringify(message));
        }
      }

      function subscribe() {
        send({
          "type": "CREATE_SUBSCRIPTION",
          "content": {
            "node_id": nodeId,
            "topic_name": topicNameInput.value,
            "message_type": messageTypeInput.value
          }
        });
      }

      function unsubscribe() {
        send({
          "type": "DESTROY_SUBSCRIPTION",
          "content": {
            "subscription_id": subscriptionId
          }
        });
      }

      function connect() {
        socket = new WebSocket(websocketUrlInput.value);

        socket.addEventListener("open", function() {
          alert("Connected to the bridge!")

          websocketUrlInput.disabled = true;
          nodeNameInput.disabled = true;
          connectButton.disabled = true;
          connectButton.value = "Connected";;

          send({
            "type": "CREATE_NODE",
            "content": {
              "node_name": nodeNameInput.value
            }
          });
        });

        socket.addEventListener("message", function(event) {
          try {
            const response = JSON.parse(event.data);
            if (response["type"] === "CREATE_NODE") {
              content = response["content"];
              if (content["error"]) {
                alert(`Failed to create node, ${content["error"]}`);
              } else {
                alert(`Node ${content["node_id"]} created!`);
                nodeId = content["node_id"];

                topicNameInput.disabled = false;
                messageTypeInput.disabled = false;
                subscribeButton.disabled = false;
                subscribeButton.value = "subscribe";
                subscribeButton.onclick = subscribe;
              }
            } else if (response["type"] === "CREATE_SUBSCRIPTION") {
              content = response["content"];
              if (content["error"]) {
                alert(`Failed to create node, ${content["error"]}`);
              } else {
                alert(`Subscription ${content["subscription_id"]} created!`);
                subscriptionId = content["subscription_id"];

                topicNameInput.disabled = true;
                messageTypeInput.disabled = true;
                subscribeButton.disabled = false;
                subscribeButton.value = "unsubscribe";
                subscribeButton.onclick = unsubscribe;
              }
            } else if (response["type"] === "DESTROY_SUBSCRIPTION") {
              content = response["content"];
              if (content["error"]) {
                alert(`Failed to destroy subscription, ${content["error"]}`);
              } else {
                alert(`Subscription ${content["subscription_id"]} destroyed!`);
                subscriptionId = null;

                topicNameInput.disabled = false;
                messageTypeInput.disabled = false;
                subscribeButton.disabled = false;
                subscribeButton.value = "subscribe";
                subscribeButton.onclick = subscribe;
              }
            } else if (response["type"] === "SUBSCRIPTION_MESSAGE") {
              content = response["content"];
              const el = document.createElement("li");
              el.appendChild(document.createTextNode(content["message"]));

              outputList.appendChild(el);
            }
          } catch (err) {
            alert(`Failed to parse message! ${err.message}`);
          }
        });

        socket.addEventListener("close", function() {
          alert("Closed from the bridge!")

          websocketUrlInput.disabled = false;
          nodeNameInput.disabled = false;
          connectButton.disabled = false;
          connectButton.value = "Connect";

          topicNameInput.disabled = true;
          messageTypeInput.disabled = true;
          subscribeButton.disabled = true;
          subscribeButton.value = "subscribe";
          subscribeButton.onclick = subscribe;
        });
      }
    </script>
  </body>
</html>
