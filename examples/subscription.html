<!DOCTYPE html>
<html>
  <head>
    <script>
      var socket = null;
      var nodeId = null;
      var id = 0;

      function send(message) {
        message.id = id;
        id += 1;

        if (socket) {
          socket.send(JSON.stringify(message));
        }
      }

      function connect() {
        socket = new WebSocket(document.getElementById("websocketUrl").value);

        socket.addEventListener("open", function() {
          alert("Connected to the bridge!")

          document.getElementById("websocketUrl").disabled = true;
          document.getElementById("nodeName").disabled = true;
          document.getElementById("connectButton").disabled = true;
          document.getElementById("connectButton").value = "Connected";;

          send({
            type: "CREATE_NODE",
            nodeName: document.getElementById("nodeName").value
          });
        });

        socket.addEventListener("message", function(event) {
          try {
            const response = JSON.parse(event.data);
            if (response.type == "CREATE_NODE") {
              if (response.error) {
                alert("Failed to create node, " + response.error);
              } else {
                alert("Node " + response.nodeId + " created!");
                nodeId = response.nodeId

                document.getElementById("topicName").disabled = false;
                document.getElementById("messageType").disabled = false;
                document.getElementById("subscribeButton").disabled = false;
              }
            } else if (response.type == "CREATE_SUBSCRIPTION") {
              if (response.error) {
                alert("Failed to create node, " + response.error);
              } else {
                alert("Subscription " + response.subscriptionId + " created!");
              }
            } else if (response.type == "SUBSCRIPTION_CALLBACK") {
              const el = document.createElement("li");
              el.appendChild(document.createTextNode(response.message));

              document.getElementById("output").appendChild(el);
            }
          } catch (err) {
            alert("Failed to parse message! " + err.message);
          }
        });

        socket.addEventListener("close", function() {
          alert("Closed from the bridge!")

          document.getElementById("websocketUrl").disabled = false;
          document.getElementById("nodeName").disabled = false;
          document.getElementById("connectButton").disabled = false;
          document.getElementById("connectButton").value = "Connect";

          document.getElementById("topicName").disabled = true;
          document.getElementById("messageType").disabled = true;
          document.getElementById("subscribeButton").disabled = true;
        });
      }

      function subscribe() {
        send({
          type: "CREATE_SUBSCRIPTION",
          nodeId: nodeId,
          topicName: document.getElementById("topicName").value,
          messageType: document.getElementById("messageType").value
        });
      }
    </script>
  </head>
  <body>
    <div>
      <label for="websocketUrl">WebSocket URL</label>
      <input type="text" id="websocketUrl" value="ws://localhost:8080">
      <label for="nodeName">Node Name</label>
      <input type="text" id="nodeName" value="subscription">
      <input type="button" id="connectButton" value="Connect" onclick="connect()">
    </div>
    <div>
      <label for="topicName">Topic Name</label>
      <input type="text" id="topicName" value="topic" disabled>
      <label for="messageType">Message Type</label>
      <input type="text" id="messageType" value="std_msgs/msg/String" disabled>
      <input type="button" id="subscribeButton" value="Subscribe" onclick="subscribe()" disabled>
    </div>
    <ul id="output">
    </ul>
  </body>
</html>
