<!DOCTYPE html>
<html>
  <head>
    <title>Subscription Example</title>
  </head>
  <body>
    <div>
      <label for="websocketUrl">WebSocket URL</label>
      <input type="text" id="websocketUrl" value="ws://localhost:8080">
      <label for="nodeName">Node Name</label>
      <input type="text" id="nodeName" value="subscription">
      <input type="button" id="connectButton" value="Connect" onclick="connect()">
    </div>
    <div>
      <label for="topicName">Topic Name</label>
      <input type="text" id="topicName" value="topic" disabled>
      <label for="messageType">Message Type</label>
      <input type="text" id="messageType" value="std_msgs/msg/String" disabled>
      <input type="button" id="subscribeButton" value="Subscribe" onclick="subscribe()" disabled>
    </div>
    <ul id="output">
    </ul>
    <script>
      const websocketUrlInput = document.getElementById("websocketUrl");
      const nodeNameInput = document.getElementById("nodeName");
      const connectButton = document.getElementById("connectButton")
      const topicNameInput = document.getElementById("topicName");
      const messageTypeInput = document.getElementById("messageType");
      const subscribeButton = document.getElementById("subscribeButton");
      const outputList = document.getElementById("output");

      var socket = null;
      var nodeId = null;
      var subscriptionId = null;
      var id = 0;

      function send(message) {
        message.id = id;
        id += 1;

        if (socket) {
          socket.send(JSON.stringify(message));
        }
      }

      function subscribe() {
        send({
          "type": "CREATE_SUBSCRIPTION",
          "node_id": nodeId,
          "topic_name": topicNameInput.value,
          "message_type": messageTypeInput.value
        });
      }

      function unsubscribe() {
        send({
          "type": "DESTROY_SUBSCRIPTION",
          "subscription_id": subscriptionId
        });
      }

      function connect() {
        socket = new WebSocket(websocketUrlInput.value);

        socket.addEventListener("open", function() {
          alert("Connected to the bridge!")

          websocketUrlInput.disabled = true;
          nodeNameInput.disabled = true;
          connectButton.disabled = true;
          connectButton.value = "Connected";;

          send({
            "type": "CREATE_NODE",
            "node_name": nodeNameInput.value
          });
        });

        socket.addEventListener("message", function(event) {
          try {
            const response = JSON.parse(event.data);
            if (response["type"] === "CREATE_NODE") {
              if (response["error"]) {
                alert(`Failed to create node, ${response["error"]}`);
              } else {
                alert(`Node ${response["node_id"]} created!`);
                nodeId = response["node_id"];

                topicNameInput.disabled = false;
                messageTypeInput.disabled = false;
                subscribeButton.disabled = false;
                subscribeButton.value = "subscribe";
                subscribeButton.onclick = subscribe;
              }
            } else if (response["type"] === "CREATE_SUBSCRIPTION") {
              if (response["error"]) {
                alert(`Failed to create node, ${response["error"]}`);
              } else {
                alert(`Subscription ${response["subscription_id"]} created!`);
                subscriptionId = response["subscription_id"];

                topicNameInput.disabled = true;
                messageTypeInput.disabled = true;
                subscribeButton.disabled = false;
                subscribeButton.value = "unsubscribe";
                subscribeButton.onclick = unsubscribe;
              }
            }  else if (response["type"] === "DESTROY_SUBSCRIPTION") {
              if (response["error"]) {
                alert(`Failed to destroy node, ${response["error"]}`);
              } else {
                alert(`Subscription ${response["subscription_id"]} destroyed!`);
                subscriptionId = null;

                topicNameInput.disabled = false;
                messageTypeInput.disabled = false;
                subscribeButton.disabled = false;
                subscribeButton.value = "subscribe";
                subscribeButton.onclick = subscribe;
              }
            } else if (response["type"] === "SUBSCRIPTION_CALLBACK") {
              const el = document.createElement("li");
              el.appendChild(document.createTextNode(response["message"]));

              outputList.appendChild(el);
            }
          } catch (err) {
            alert(`Failed to parse message! ${err.message}`);
          }
        });

        socket.addEventListener("close", function() {
          alert("Closed from the bridge!")

          websocketUrlInput.disabled = false;
          nodeNameInput.disabled = false;
          connectButton.disabled = false;
          connectButton.value = "Connect";

          topicNameInput.disabled = true;
          messageTypeInput.disabled = true;
          subscribeButton.disabled = true;
          subscribeButton.value = "subscribe";
          subscribeButton.onclick = subscribe;
        });
      }
    </script>
  </body>
</html>
